<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>🎵 Test Générateur Suno 🎵</title>
</head>
<body style="background:#111; color:#eee; font-family:sans-serif; padding:20px;">
  <h1>🎵 Test Générateur Suno 🎵</h1>
  <input id="title" placeholder="Titre" value="Mystic Ceremony" /><br><br>
  <textarea id="prompt" placeholder="Prompt">shamanic flute ambient tribal mystic</textarea><br><br>
  <button onclick="generate()">Lancer</button>
  <div id="result" style="margin-top:20px;"></div>

  <script>
    async function generate() {
      const title = document.getElementById('title').value;
      const prompt = document.getElementById('prompt').value;

      const res = await fetch('/api/generate-music', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, prompt })
      });

      const data = await res.json();
      if (!res.ok) return alert('Erreur API: ' + (data?.error || 'Inconnue'));

      const taskId = data?.taskIds?.[0];
      if (!taskId) return alert('Erreur : aucune tâche créée.');

      document.getElementById('result').innerText = 'Tâche en cours : ' + taskId;

      // Polling
      const interval = setInterval(async () => {
        const statusRes = await fetch('/api/check-task?taskId=' + taskId);
        const statusData = await statusRes.json();

        if (statusData.audio_url) {
          clearInterval(interval);
          document.getElementById('result').innerHTML = `
            ✅ Généré !<br>
            <audio controls src="${statusData.audio_url}"></audio><br>
            <a href="${statusData.audio_url}" download>Télécharger</a>
          `;
        }
      }, 5000);
    }
  </script>
</body>
</html>