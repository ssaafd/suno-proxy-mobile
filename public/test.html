<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Test G√©n√©rateur Suno</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; max-width:600px; margin:auto; }
    input, textarea, button { width:100%; margin:0.5rem 0; padding:0.8rem; }
    button { background:#0070f3; color:#fff; border:none; cursor:pointer; }
    .loader { margin-top:1rem; color:#555; }
    audio { margin-top:1rem; width:100%; }
    img { margin-top:1rem; max-width:100%; }
  </style>
</head>
<body>
  <h1>üé∂ Test G√©n√©rateur Suno</h1>
  <input id="title" placeholder="Titre" value="Mystic Ceremony">
  <textarea id="prompt">shamanic flute ambient tribal mystic</textarea>
  <button id="generate">G√©n√©rer la musique</button>
  <div class="loader" id="loader"></div>
  <img id="cover" style="display:none;">
  <audio controls id="player" style="display:none;"></audio>

<script>
  document.getElementById('generate').onclick = async () => {
    const title = document.getElementById('title').value;
    const prompt = document.getElementById('prompt').value;
    const loader = document.getElementById('loader');
    const player = document.getElementById('player');
    const cover = document.getElementById('cover');

    loader.textContent = '‚è≥ G√©n√©ration en cours‚Ä¶';
    player.style.display = 'none';
    cover.style.display = 'none';

    const res = await fetch('/api/generate-music', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, prompt })
    });

    const data = await res.json();
    if (!data.task_id) {
      loader.textContent = '‚ùå ' + (data.error || 'Erreur g√©n√©ration');
      console.error('generate error', data);
      return;
    }

    const taskId = data.task_id;
    const poll = setInterval(async () => {
      const st = await fetch(`/api/status/${taskId}`);
      const info = await st.json();
      console.log('status info', info);

      if (info.status === 'SUCCESS' && info.audio_url) {
        clearInterval(poll);
        loader.textContent = '‚úÖ G√©n√©ration termin√©e';
        player.src = info.audio_url;
        player.style.display = 'block';
        if (info.cover_url) {
          cover.src = info.cover_url;
          cover.style.display = 'block';
        }
      } else if (info.status === 'FAILED') {
        clearInterval(poll);
        loader.textContent = '‚ùå √âchec sur g√©n√©ration';
      }
    }, 4000);
  };
</script>

</body>
</html>